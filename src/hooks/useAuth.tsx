import React, { createContext, useContext, useState, useEffect } from 'react';
import { toast } from 'sonner';
import { getSupabaseClient } from '@/lib/supabase'; // Importe o cliente Supabase

// Definir tipos para o usu√°rio
export interface User {
  id: string; // O ID do Supabase √© uma string (UUID)
  name: string;
  email: string;
  avatar?: string;
  plan: 'free' | 'pro' | 'business';
  tubecoins: number;
  level: number;
  experience: number;
  experienceToNextLevel: number;
  usageHistory: {
    date: string;
    feature: string;
    coinsSpent: number;
  }[];
}

// Definir tipo para o contexto de autentica√ß√£o
interface AuthContextType {
  user: User | null;
  login: (email: string, password: string) => Promise<void>;
  register: (name: string, email: string, password: string) => Promise<void>;
  logout: () => void;
  resetPassword: (email: string) => Promise<void>;
  isLoading: boolean;
  earnCoins: (amount: number, reason: string) => void;
  spendCoins: (amount: number, feature: string) => boolean;
  earnExperience: (amount: number) => void;
}

// Criar contexto
const AuthContext = createContext<AuthContextType | undefined>(undefined);

// Hook para usar o contexto
export const useAuth = () => {
  const context = useContext(AuthContext);
  if (context === undefined) {
    throw new Error('useAuth deve ser usado dentro de um AuthProvider');
  }
  return context;
};

// Calcular experi√™ncia necess√°ria para o pr√≥ximo n√≠vel
const calculateExperienceForLevel = (level: number) => {
  return Math.floor(100 * Math.pow(1.5, level - 1));
};

// Provedor do contexto
export const AuthProvider: React.FC<{ children: React.ReactNode }> = ({ children }) => {
  const [user, setUser] = useState<User | null>(null);
  const [isLoading, setIsLoading] = useState<boolean>(true);

  const supabase = getSupabaseClient(); // Obtenha a inst√¢ncia do Supabase

  // Carregar usu√°rio da sess√£o Supabase ao iniciar
  useEffect(() => {
    const fetchUser = async () => {
      setIsLoading(true);
      try {
        const { data: { user: supabaseUser }, error } = await supabase.auth.getUser();

        if (error) {
          // Tratar AuthSessionMissingError como informa√ß√£o, pois √© esperado para usu√°rios deslogados
          if (error.name === 'AuthSessionMissingError') {
            console.info("Nenhuma sess√£o de autentica√ß√£o encontrada (esperado para usu√°rios deslogados).");
          } else {
            console.error("Erro ao buscar usu√°rio do Supabase:", error);
            toast.error(error.message || "Erro desconhecido ao buscar usu√°rio.");
          }
          setUser(null);
        } else if (supabaseUser) {
          // Se o usu√°rio estiver logado no Supabase, tente buscar os dados dele no seu banco de dados
          const { data: userData, error: dbError } = await supabase
            .from('profiles') // Assumindo que voc√™ ter√° uma tabela 'profiles' para dados adicionais do usu√°rio
            .select('*')
            .eq('id', supabaseUser.id)
            .single();

          if (dbError && dbError.details?.includes('zero rows')) {
            // Se o perfil n√£o existir, crie um perfil b√°sico
            const initialUser: User = {
              id: supabaseUser.id,
              name: supabaseUser.email?.split('@')[0] || 'Novo Usu√°rio',
              email: supabaseUser.email || '',
              plan: 'free',
              tubecoins: 100, // B√¥nus inicial de registro
              level: 1,
              experience: 0,
              experienceToNextLevel: calculateExperienceForLevel(1),
              usageHistory: []
            };
            const { data: newProfile, error: insertError } = await supabase
              .from('profiles')
              .insert(initialUser)
              .select()
              .single();

            if (insertError) {
              console.error("Erro ao inserir perfil inicial no fetchUser:", insertError);
              toast.error("Erro ao carregar perfil. Tente novamente.");
            } else {
              setUser(newProfile as User);
              toast.success('Bem-vindo ao TubePro! Voc√™ ganhou 100 Tubecoins de b√¥nus!');
            }
          } else if (dbError) {
            console.error("Erro ao buscar perfil do usu√°rio:", dbError);
            toast.error("Erro ao carregar perfil. Tente novamente.");
          } else {
            setUser(userData as User);
          }
        } else {
          setUser(null);
        }
      } catch (e: any) { // Capture como 'any' para acessar 'message' com seguran√ßa
        console.error("Erro inesperado no AuthProvider ao carregar usu√°rio:", e);
        toast.error(e.message || "Erro desconhecido ao carregar usu√°rio.");
        setUser(null);
      } finally {
        setIsLoading(false);
      }
    };

    fetchUser();

    // Adiciona um listener para mudan√ßas de estado de autentica√ß√£o
    const { data: authListener } = supabase.auth.onAuthStateChange(
      (event, session) => {
        if (event === 'SIGNED_IN' && session?.user) {
          fetchUser(); // Refetch user data when signed in
        } else if (event === 'SIGNED_OUT') {
          setUser(null);
        }
      }
    );

    return () => {
      authListener?.subscription.unsubscribe();
    };
  }, [supabase]);


  // Fun√ß√£o para ganhar Tubecoins
  const earnCoins = (amount: number, reason: string) => {
    if (!user) return;

    // TODO: Implementar atualiza√ß√£o no banco de dados Supabase
    const updatedUser = {
      ...user,
      tubecoins: user.tubecoins + amount
    };

    setUser(updatedUser);
    toast.success(`+${amount} Tubecoins: ${reason}`);
  };

  // Fun√ß√£o para gastar Tubecoins
  const spendCoins = (amount: number, feature: string): boolean => {
    if (!user) return false;

    if (user.tubecoins < amount) {
      toast.error(`Tubecoins insuficientes para usar ${feature}`);
      return false;
    }

    const currentDate = new Date().toISOString();

    // TODO: Implementar atualiza√ß√£o no banco de dados Supabase
    const updatedUser = {
      ...user,
      tubecoins: user.tubecoins - amount,
      usageHistory: [
        ...(user.usageHistory || []),
        { date: currentDate, feature, coinsSpent: amount }
      ]
    };

    setUser(updatedUser);
    toast.info(`-${amount} Tubecoins: ${feature}`);

    // Ganha experi√™ncia ao usar recursos
    earnExperience(Math.floor(amount / 2));

    return true;
  };

  // Fun√ß√£o para ganhar experi√™ncia
  const earnExperience = (amount: number) => {
    if (!user) return;

    let updatedUser = { ...user };
    updatedUser.experience += amount;

    // Verifica se subiu de n√≠vel
    while (updatedUser.experience >= updatedUser.experienceToNextLevel) {
      updatedUser.experience -= updatedUser.experienceToNextLevel;
      updatedUser.level += 1;
      updatedUser.experienceToNextLevel = calculateExperienceForLevel(updatedUser.level);

      // B√¥nus ao subir de n√≠vel
      updatedUser.tubecoins += updatedUser.level * 10;
      toast.success(`üéâ N√≠vel ${updatedUser.level} alcan√ßado! +${updatedUser.level * 10} Tubecoins de b√¥nus!`);
    }

    // TODO: Implementar atualiza√ß√£o no banco de dados Supabase
    setUser(updatedUser);
  };

  // Fun√ß√£o de login com Supabase
  const login = async (email: string, password: string) => {
    setIsLoading(true);
    try {
      const { data, error } = await supabase.auth.signInWithPassword({
        email,
        password,
      });

      if (error) {
        // Agora, 'error' √© do tipo 'PostgrestError' ou similar, com uma propriedade 'message'
        toast.error(error.message || 'Falha no login. Verifique suas credenciais.');
        throw error;
      }

      // Se o login for bem-sucedido, fetchUser no useEffect cuidar√° de carregar o perfil
      toast.success('Login realizado com sucesso!');
    } catch (error: any) { // Capture como 'any' para acessar 'message' com seguran√ßa
      console.error('Erro no login:', error);
      // Evita duplicidade de toast se o erro j√° foi exibido acima
      if (!error.message) { // Se n√£o tem uma mensagem espec√≠fica, √© um erro inesperado
        toast.error('Ocorreu um erro inesperado no login. Por favor, tente novamente.');
      }
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  // Fun√ß√£o de registro com Supabase
  const register = async (name: string, email: string, password: string) => {
    setIsLoading(true);
    try {
      const { data: signUpData, error: signUpError } = await supabase.auth.signUp({
        email,
        password,
        options: {
          data: {
            full_name: name, // Supabase user metadata
          },
        },
      });

      if (signUpError) {
        if (signUpError.message.includes('already registered')) {
          toast.error('Este e-mail j√° est√° registrado. Por favor, fa√ßa login ou use outro e-mail.');
        } else if (signUpError.message.includes('Password should be at least')) {
          toast.error('A senha √© muito fraca. Ela deve ter pelo menos 6 caracteres.');
        } else {
          toast.error(signUpError.message || 'Falha no registro. Tente novamente.');
        }
        return; // Sair da fun√ß√£o se houver um erro no signUp
      }

      // Se signUpData.user for nulo, geralmente significa que a confirma√ß√£o de email √© necess√°ria
      // e o usu√°rio n√£o est√° logado automaticamente ap√≥s o registro.
      if (!signUpData.user) {
        toast.info('Verifique seu e-mail para confirmar a conta antes de fazer login. Um link de confirma√ß√£o foi enviado.');
        return; // Sair da fun√ß√£o se a confirma√ß√£o de e-mail for necess√°ria
      }

      // Se chegou aqui, o usu√°rio foi criado no auth.users e logado automaticamente (se a confirma√ß√£o de email estiver desativada).
      // Agora insere o perfil inicial no seu banco de dados (tabela 'profiles').
      const initialUser: User = {
        id: signUpData.user.id,
        name: name,
        email: email,
        plan: 'free',
        tubecoins: 100, // B√¥nus inicial de registro
        level: 1,
        experience: 0,
        experienceToNextLevel: calculateExperienceForLevel(1),
        usageHistory: []
      };

      const { error: insertProfileError } = await supabase.from('profiles').insert(initialUser);

      if (insertProfileError) {
        // Se a inser√ß√£o do perfil falhar (ex: por FK constraint, RLS, etc.)
        console.error('Erro ao inserir perfil do usu√°rio:', insertProfileError);
        toast.error(`Conta criada, mas houve um erro ao configurar seu perfil: ${insertProfileError.message || 'Erro desconhecido'}. Por favor, tente fazer login. Se o problema persistir, entre em contato com o suporte.`);
        return; // Sair da fun√ß√£o se a inser√ß√£o do perfil falhar
      }

      toast.success('Conta criada com sucesso! Voc√™ ganhou 100 Tubecoins de b√¥nus!');
      // O fetchUser no useEffect cuidar√° do carregamento do perfil completo ap√≥s o login autom√°tico.

    } catch (error: any) { // Use 'any' para o erro geral, ou refine o tipo se souber qual √©
      // Este catch final √© para erros inesperados que n√£o foram pegos acima.
      console.error('Erro inesperado no registro:', error);
      // N√£o exibe toast aqui para evitar duplicidade, a menos que seja um erro gen√©rico n√£o espec√≠fico
    } finally {
      setIsLoading(false);
    }
  };

  // Fun√ß√£o de recupera√ß√£o de senha com Supabase
  const resetPassword = async (email: string) => {
    setIsLoading(true);
    try {
      const { error } = await supabase.auth.resetPasswordForEmail(email, {
        redirectTo: `${window.location.origin}/update-password`, // URL para onde o usu√°rio ser√° redirecionado
      });

      if (error) {
        toast.error(error.message || 'Falha no envio do link de recupera√ß√£o. Tente novamente.');
        throw error;
      }

      toast.success(`Link de recupera√ß√£o enviado para ${email}. Verifique sua caixa de entrada.`);
    } catch (error: any) {
      console.error('Erro na recupera√ß√£o de senha:', error);
      toast.error(error.message || 'Falha no envio do link de recupera√ß√£o. Tente novamente.');
      throw error;
    } finally {
      setIsLoading(false);
    }
  };

  // Fun√ß√£o de logout com Supabase
  const logout = async () => {
    setIsLoading(true);
    try {
      const { error } = await supabase.auth.signOut();
      if (error) {
        toast.error(error.message || 'Falha ao desconectar.');
        throw error;
      }
      setUser(null);
      toast.info('Voc√™ foi desconectado');
    } catch (error: any) {
      console.error('Erro ao fazer logout:', error);
      // Evita duplicidade de toast se o erro j√° foi exibido acima
      if (!error.message) {
        toast.error('Ocorreu um erro inesperado ao fazer logout. Tente novamente.');
      }
    } finally {
      setIsLoading(false);
    }
  };

  const value = {
    user,
    login,
    register,
    logout,
    resetPassword,
    isLoading,
    earnCoins,
    spendCoins,
    earnExperience
  };

  return <AuthContext.Provider value={value}>{children}</AuthContext.Provider>;
};